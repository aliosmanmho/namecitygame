<html>

<head>
    <meta name="viewport" content="user-scalable=no" />
    <link rel="stylesheet" href="/bootstrap/dist/css/bootstrap.min.css" type="text/css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="/bootstrap/dist/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();
        var questionsWithRows = [];
        var questionArray = [];
        var questionRow = [];
        var gameId = "";
        var levelQuesiton;
        var currentRowIndex;
        var maxRowIndex;
        socket.on('GameStartStep', function (msg) {
            currentRowIndex=msg;
            questionRow = questionsWithRows[currentRowIndex];
            maxRowIndex = questionsWithRows.length-1;
            questionArray = questionRow.question;
            QuestionShow(questionArray[0]);

        });
        socket.on('playerAnswer', function (msg) {
            var data = JSON.parse(msg);
            $('#Answertable-'+data.playerId+data.questionId).text(data.value);
        });

        function QuestionShow(question) {
            $('#questiontitle').text(question.value);
            $('#quesionID').val(question.id);
            $('#QuerstionModel').modal();
            
        }
        function LevelQuestionAppendForms(msg) {
            if (levelQuesiton == null) {
                levelQuesiton = JSON.parse(msg);
            }
            if (levelQuesiton != null) {
                questionsWithRows = levelQuesiton.questions;
                $(".table").each(function () {
                    var currentElement = $(this);
                    currentElement.empty();
                    var strHead = "<thead><tr><th scope='col'>#</th>";
                    levelQuesiton.questionsHead.forEach(questionHead => {
                        strHead += "<th scope='col'>" + questionHead + "</th>"
                    });
                    strHead += "</tr></thead>";
                    strHead += "<tbody>";
                    var rowCount = 1;
                    for (rowQuestions of questionsWithRows) {
                        strHead += "<tr> <th scope='row'>" + rowCount + "</th>";
                        for (quest of rowQuestions.question) {
                            //Answer+playerid+questionid
                            strHead += "<td id='Answer" + $(this).attr('id') + quest.id + "'></td>";
                        }
                        strHead += "</tr>";
                        rowCount++;
                    }
                    strHead += "</tbody>";
                    currentElement.append(strHead);
                });

            }
        }
        socket.on('gameJoined', function (msg) {
            $('#gamersTabPanel').empty();
            $('#gamersTabPanelContent').empty();
            var data = JSON.parse(msg);
            if (data != null) {
                data.players.forEach(player => {
                    var isActive="";
                    var areaSelected = "false";
                    var nalinkActive="";
                    if(socket.id == player.id)
                    {
                        isActive="show active";
                        areaSelected="true";
                        nalinkActive="active";
                    }
                    $("<li id='navitem" + player.id + "' class='nav-item'></li>").appendTo('#gamersTabPanel');
                    $("<a class='nav-link "+nalinkActive+"' id='pills-tab" + player.id + "' data-toggle='pill' href='#pills-" + player.id + "' role='tab' aria-controls='pills-" + player.id + "' aria-selected='"+areaSelected+"'>" + player.name + "</a>").appendTo('#navitem' + player.id);
                    $("<div class='tab-pane fade "+isActive+"' id='pills-" + player.id + "' role='tabpanel' aria-labelledby='pills-" + player.id + "'></div>").appendTo('#gamersTabPanelContent');

                    $("<table id='table-" + player.id + "' class='table'>").appendTo('#pills-' + player.id);
                });
            }
            if (levelQuesiton != null) { LevelQuestionAppendForms(""); }
            console.log(msg);
        });
        socket.on('levelQuestion', function (msg) {
            LevelQuestionAppendForms(msg);
        });
        socket.on('gameOut', function (msg) {
            alert("Oyuncu Çıktı Oyun Bitti!");
            document.location.href="/";
            console.log(msg);
        });
        socket.on('errorSocet', function (msg) {
            alert(msg);
        });
        socket.on('myClientError', function (msg) {
            alert(msg);
        });

        $(document).ready(function () {
            if (window.location.search != "") {
                gameId = window.location.search.replace("?", "");
            }
            $('#gameName').text("Oyun : " + gameId);
            $('#myModal').modal();
            $('#myModal').on('hidden.bs.modal', function (e) {
                var playerName = $("#txtName").val();
                socket.emit("CreatePlayer", playerName);
                if (gameId != null) {

                    socket.emit("joinGame", gameId);
                }
            });
            $('#QuerstionModel').on('hidden.bs.modal', function (e) {
                var questionAnswer = $("#questionAnswer").val();
                var quesionID = $("#quesionID").val();
                socket.emit("AnswerQuestion", gameId, quesionID, questionAnswer);
                const index = questionArray.findIndex(quest => quest.id == quesionID);
                if(questionArray.length>index+1)
                    {
                        QuestionShow(questionArray[index+1]);
                    }
                    else
                    {
                        if(maxRowIndex > currentRowIndex + 1)
                        {
                            socket.emit("QuestionRowFinish", gameId,currentRowIndex);
                        }
                        else
                        {
                            socket.emit("GameFinish", gameId);
                        }
                    }
                //if(questionRow.question.indexOf(question))
            });
        }); 
    </script>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 id="gameName"></h1>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-pills" id="gamersTabPanel" role="tablist">
                </ul>
                <div class="tab-content" id="gamersTabPanelContent">
                </div>
                <!-- Modal -->
                <div id="myModal" class="modal fade" role="dialog" data-backdrop="static">
                    <div class="modal-dialog">

                        <!-- Modal content-->
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Oyuncu Adı</h4>
                            </div>
                            <div class="modal-body">
                                <input type="text" id="txtName">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Giriş</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- QuerstionModel -->
                <div id="QuerstionModel" class="modal fade" role="dialog" data-backdrop="static">
                    <div class="modal-dialog">

                        <!-- Modal content-->
                        <div class="modal-content">
                            <div class="modal-header">
                                <input type="text" id="quesionID" style="display: none;">
                                <h4 id="questiontitle" class="modal-title"></h4>
                            </div>
                            <div class="modal-body">
                                <input type="text" id="questionAnswer">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Cevap Ver</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>